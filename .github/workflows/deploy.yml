name: Deploy to VPS

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy files to server
        run: |
          rsync -av --exclude='.git' $GITHUB_WORKSPACE/ /srv/projects/livelink/

      - name: Create .env file
        run: |
          cat > /srv/projects/livelink/.env <<EOF
          VIRTUAL_HOST=${{ secrets.VIRTUAL_HOST }}
          LETSENCRYPT_HOST=${{ secrets.VIRTUAL_HOST }}
          LETSENCRYPT_EMAIL=${{ secrets.LETSENCRYPT_EMAIL }}
          NODE_ENV=production
          DB_HOST=db
          DB_PORT=5432
          DB_NAME=livelink_db
          DB_USER=livelink_user
          DB_PASSWORD=0UuJiS9C1YKfALpT
          REACT_APP_API_URL=https://api.${{ secrets.VIRTUAL_HOST }}
          EOF

      - name: Build Backend Docker image
        run: |
          cd /srv/projects/livelink
          docker build -t livelink/livelink-back:latest ./liveshop-backend

      - name: Build Frontend Docker image
        run: |
          cd /srv/projects/livelink
          docker build -t livelink/livelink-front:latest ./web-client/liveshop-client

      - name: Build Mobile Docker image
        run: |
          cd /srv/projects/livelink
          docker build -t livelink/livelink-mobile:latest ./mobile-app/liveshop-vendor

      - name: Validate resource limits
        run: |
          cat > /tmp/validate.sh << 'VALIDATE_SCRIPT'
          #!/bin/bash
          set -e
          TIER="pro"
          COMPOSE_FILE="$GITHUB_WORKSPACE/docker-compose.yml"

          declare -A RAM_LIMITS=( ["starter"]=512 ["pro"]=2048 ["business"]=4096 )
          declare -A CPU_LIMITS=( ["starter"]=0.5 ["pro"]=2 ["business"]=4 )

          MAX_RAM=${RAM_LIMITS[$TIER]}
          MAX_CPU=${CPU_LIMITS[$TIER]}

          echo "ðŸ” Validation tier: $TIER (${MAX_RAM}MB RAM, ${MAX_CPU} CPU max)"

          # VÃ©rifier mÃ©moire
          MEM_LIMITS=$(grep -E "mem_limit:" "$COMPOSE_FILE" | awk '{print $2}' | tr -d 'm' | tr -d '"' || echo "")
          TOTAL_RAM=0
          for limit in $MEM_LIMITS; do
            if [[ $limit =~ ^[0-9]+$ ]]; then
              TOTAL_RAM=$((TOTAL_RAM + limit))
            fi
          done

          if (( TOTAL_RAM > MAX_RAM )); then
            echo "âŒ VIOLATION: ${TOTAL_RAM}MB dÃ©passe le maximum autorisÃ© (${MAX_RAM}MB)"
            echo "   Contactez: info@nexteranga.com pour upgrader"
            exit 1
          fi

          echo "âœ… Ressources conformes (${TOTAL_RAM}MB / ${MAX_RAM}MB)"
          VALIDATE_SCRIPT

          chmod +x /tmp/validate.sh
          /tmp/validate.sh

      - name: Deploy with Docker Compose
        run: |
          cd /srv/projects/livelink
          docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          sleep 15
          echo "ðŸ” VÃ©rifying services..."
          docker ps | grep -E "livelink-(backend|dashboard|mobile|db)"

      - name: Health check
        run: |
          curl -f https://livelink.store || echo "â³ Site not yet ready (SSL provisioning may take 2-5 min)"
          curl -f https://api.livelink.store || echo "â³ API not yet ready"
          curl -f https://space.livelink.store || echo "â³ Mobile not yet ready"

      - name: Cleanup old images
        run: |
          docker image prune -f

      - name: Show container logs
        if: failure()
        run: |
          docker logs livelink-backend --tail 30 2>/dev/null || true
          docker logs livelink-dashboard --tail 30 2>/dev/null || true
          docker logs livelink-mobile --tail 30 2>/dev/null || true
          docker logs livelink-db --tail 30 2>/dev/null || true